# Telegram Bot - Backend Integration

Этот документ описывает интеграцию телеграм бота с backend API для централизованного управления пользователями, генерацией изображений и загрузкой на стоковые сервисы.

## Изменения в архитектуре

### До интеграции (index.js)
- Автономная работа бота
- Прямое подключение к OpenAI API
- Прямая загрузка на 123RF через FTP
- Локальное хранение настроек

### После интеграции (index-new.js)
- Централизованное управление через backend API
- Единая база данных пользователей
- Безопасное хранение учетных данных
- Поддержка множественных стоковых сервисов
- Отслеживание статистики и загрузок

## Новые возможности

### 1. Управление пользователями
- Автоматическое создание/получение пользователя при первом обращении
- Синхронизация профиля с Telegram данными
- Централизованное хранение настроек

### 2. Управление стоковыми сервисами
- Поддержка 123RF, Shutterstock, Adobe Stock
- Безопасное хранение учетных данных с шифрованием
- Пошаговая настройка через бота
- Проверка подключения к сервисам

### 3. Расширенная функциональность
- История сгенерированных изображений
- Статистика использования
- Отслеживание статуса загрузок
- Управление подписками и лимитами

## Установка и настройка

### 1. Установка зависимостей
```bash
cd tg-bot
npm install axios
```

### 2. Настройка переменных окружения
Скопируйте `.env.example` в `.env` и настройте:

```env
# Telegram Bot Token from BotFather
TELEGRAM_TOKEN=your_telegram_token_here

# Backend API Configuration
BACKEND_API_URL=http://localhost:3000/api
BACKEND_API_TIMEOUT=30000

# Demo Mode (set to 'true' to use mock images instead of OpenAI)
DEMO_MODE=false
```

### 3. Запуск backend сервера
Убедитесь, что backend сервер запущен:
```bash
cd ../backend
npm start
```

### 4. Тестирование интеграции
Запустите тест интеграции:
```bash
cd tg-bot
node test-backend-integration.js
```

### 5. Запуск бота
```bash
# Старая версия (автономная)
node index.js

# Новая версия (с backend интеграцией)
node index-new.js
```

## Новые команды бота

### Основные команды
- `/start` - Приветствие и инициализация пользователя
- `/help` - Справка по использованию
- `/settings` - Настройки профиля и генерации
- `/mystocks` - Управление стоковыми сервисами
- `/myimages` - История сгенерированных изображений
- `/stats` - Статистика пользователя

### Интерактивные элементы
- **Inline кнопки** для загрузки на стоки
- **Пошаговая настройка** стоковых сервисов
- **Статус загрузок** в реальном времени
- **Управление настройками** через меню

## Логика работы

### 1. Инициализация пользователя
```javascript
// При каждом сообщении
const user = await initializeUser(msg.from);
// Создает или получает пользователя из backend
```

### 2. Проверка стоковых сервисов
```javascript
// Проверка наличия активных стоков
const hasActiveStocks = await backendApi.hasActiveStockServices(user.id);
if (!hasActiveStocks) {
  // Показать меню настройки стоков
  return showStockSetupMenu(chatId, user.id);
}
```

### 3. Генерация изображения
```javascript
// Генерация через backend API
const imageData = await backendApi.generateImage({
  userId: user.id,
  userExternalId: user.externalId,
  prompt: prompt,
  options: { model: 'dall-e-3', size: '1024x1024' }
});
```

### 4. Загрузка на стоки
```javascript
// Загрузка через backend API
const uploadResult = await backendApi.uploadToStock({
  userId: user.id,
  imageId: imageId,
  service: service,
  title: title,
  description: description,
  keywords: keywords
});
```

## Безопасность

### 1. Шифрование данных
- Все пароли и секретные ключи шифруются в backend
- Телеграм бот не хранит чувствительные данные локально

### 2. Валидация
- Проверка доступности backend перед операциями
- Валидация пользовательского ввода
- Обработка ошибок и fallback сценарии

### 3. Логирование
- Структурированные логи всех операций
- Отслеживание ошибок и производительности
- Безопасное логирование без чувствительных данных

## Миграция с старой версии

### 1. Подготовка
- Убедитесь, что backend сервер настроен и работает
- Настройте переменные окружения
- Протестируйте интеграцию

### 2. Переключение
```bash
# Остановите старый бот
# Запустите новый бот
node index-new.js
```

### 3. Настройка пользователей
- Существующие пользователи будут автоматически созданы в backend
- Потребуется повторная настройка стоковых сервисов
- История изображений начнется с нуля

## Troubleshooting

### Backend недоступен
```
⚠️ Сервис временно недоступен. Попробуйте позже.
```
**Решение:** Проверьте, что backend сервер запущен и доступен по указанному URL.

### Ошибка создания пользователя
```
❌ Произошла ошибка при инициализации. Попробуйте позже.
```
**Решение:** Проверьте логи backend сервера и подключение к MongoDB.

### Ошибка генерации изображения
```
❌ Не удалось сгенерировать изображение.
```
**Решение:** Проверьте настройки OpenAI API в backend и доступность сервиса.

### Ошибка загрузки на стоки
```
❌ Ошибка загрузки на 123RF. Попробуйте позже.
```
**Решение:** Проверьте настройки FTP в профиле пользователя и доступность стокового сервиса.

## Мониторинг

### Логи бота
```bash
# Просмотр логов в реальном времени
tail -f bot.log
```

### Логи backend
```bash
# Просмотр логов backend
cd ../backend
npm run logs
```

### Метрики
- Количество активных пользователей
- Статистика генерации изображений
- Успешность загрузок на стоки
- Время отклика API

## Дальнейшее развитие

### Планируемые улучшения
1. **Автоматическая загрузка** - настройка автозагрузки на выбранные стоки
2. **Пакетная обработка** - загрузка нескольких изображений одновременно
3. **Аналитика** - детальная статистика и отчеты
4. **Уведомления** - push-уведомления о статусе загрузок
5. **Интеграция с другими стоками** - расширение списка поддерживаемых сервисов

### API расширения
- Webhook для уведомлений о статусе загрузок
- REST API для внешних интеграций
- GraphQL для сложных запросов
- WebSocket для real-time обновлений

## Поддержка

Для получения помощи:
1. Проверьте логи бота и backend
2. Запустите тест интеграции
3. Обратитесь к документации backend API
4. Создайте issue в репозитории проекта
