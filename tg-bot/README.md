# AI Stock Bot - Telegram Bot

Telegram –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è AI Stock Bot - —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ AI –º–æ–¥–µ–ª—è–º–∏, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ø–ª–∞—Ç–µ–∂–µ–π YooMoney –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å—Ç–æ–∫–æ–≤—ã–µ –ø–ª–æ—â–∞–¥–∫–∏.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#-–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Telegram Bot](#Ô∏è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-telegram-bot)
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- [–ö–æ–º–∞–Ω–¥—ã –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å](#-–∫–æ–º–∞–Ω–¥—ã-–∏-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Backend API](#-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-backend-api)
- [–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏](#-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è](#-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–∏-–≤–∞–ª–∏–¥–∞—Ü–∏—è)
- [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](#-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [Docker Development](#-docker-development)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [–ü–æ–¥–¥–µ—Ä–∂–∫–∞](#-–ø–æ–¥–¥–µ—Ä–∂–∫–∞)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- **Node.js** 18+ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 20+)
- **Telegram Bot Token** –æ—Ç [@BotFather](https://t.me/BotFather)
- **–ó–∞–ø—É—â–µ–Ω–Ω—ã–π Backend API** (—Å–º. [Backend README](../backend/README.md))
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ Telegram –±–æ—Ç–∞

1. **–°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotFather**:
   ```
   /start
   /newbot
   –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: AI Stock Bot
   –í–≤–µ–¥–∏—Ç–µ username: your_bot_name_bot
   ```

2. **–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω** –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```
   /setcommands
   start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
   help - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
   balance - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   buy - –ö—É–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   mystocks - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–∫–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
   ```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

#### –ß–µ—Ä–µ–∑ Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```bash
# –ò–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend —É–∂–µ –∑–∞–ø—É—â–µ–Ω
docker-compose --profile backend up -d

# –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞
docker-compose --profile bot up -d

# –ò–ª–∏ –∑–∞–ø—É—Å–∫ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã —Å—Ä–∞–∑—É
docker-compose --profile backend --profile bot up -d
```

#### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
cd tg-bot
npm install
cp .env.example .env
# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ .env
npm start
```

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –±–æ—Ç–∞
docker-compose logs tg-bot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Backend API
curl http://localhost:3000/api/health

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Telegram
# –ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Telegram Bot

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
tg-bot/
‚îú‚îÄ‚îÄ index.js                    # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ backendApiService.js    # HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Backend API
‚îú‚îÄ‚îÄ package.json                # NPM –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env.example               # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ Dockerfile                 # Docker –æ–±—Ä–∞–∑ –¥–ª—è production
‚îî‚îÄ‚îÄ README.md                  # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –±–æ—Ç–∞
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### **Main Bot Handler** (`index.js`)
- **Telegram Bot API**: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º
- **Command Processing**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (/start, /help, /balance, etc.)
- **Message Handling**: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ–º–ø—Ç–æ–≤
- **Callback Queries**: –û–±—Ä–∞–±–æ—Ç–∫–∞ inline –∫–Ω–æ–ø–æ–∫ –∏ –º–µ–Ω—é
- **Session Management**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏
- **Error Handling**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ fallback —Ä–µ–∂–∏–º—ã

#### **Backend API Service** (`services/backendApiService.js`)
- **HTTP Client**: Axios –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Backend API
- **Stream Handling**: –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **Error Recovery**: Retry –ª–æ–≥–∏–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤
- **Demo Mode**: Fallback –Ω–∞ –¥–µ–º–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
- **Request Validation**: –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

#### **Event-Driven Architecture**
```javascript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π Telegram
bot.on('message', handleTextMessage);
bot.on('callback_query', handleCallbackQuery);
bot.on('polling_error', handlePollingError);
```

#### **Stateless Design**
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ–∑–∞–≤–∏—Å–∏–º
- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Backend API
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### **Graceful Degradation**
- Demo —Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Backend
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```bash
# Telegram Bot Configuration
BOT_TOKEN=your_telegram_bot_token_from_botfather

# Backend API Integration
BACKEND_API_URL=http://backend:3000/api
```

#### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```bash
# Timeouts –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
BACKEND_API_TIMEOUT=120000          # –¢–∞–π–º–∞—É—Ç API –∑–∞–ø—Ä–æ—Å–æ–≤ (2 –º–∏–Ω—É—Ç—ã)
IMAGE_GENERATION_TIMEOUT=180000     # –¢–∞–π–º–∞—É—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (3 –º–∏–Ω—É—Ç—ã)

# –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã
DEMO_MODE=false                     # –î–µ–º–æ —Ä–µ–∂–∏–º —Å fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
NODE_ENV=development                # –û–∫—Ä—É–∂–µ–Ω–∏–µ (development/production)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
LOG_LEVEL=info                      # –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (debug/info/warn/error)

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
MAX_PROMPT_LENGTH=1000              # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞
SESSION_TIMEOUT=300000              # –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–π (5 –º–∏–Ω—É—Ç)
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

#### Telegram API –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
```javascript
const TELEGRAM_LIMITS = {
  MESSAGE_LENGTH: 4096,           // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  PHOTO_SIZE: 10 * 1024 * 1024,  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ (10MB)
  REQUESTS_PER_SECOND: 30,       // –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
  REQUESTS_PER_MINUTE: 20        // –õ–∏–º–∏—Ç –¥–ª—è –≥—Ä—É–ø–ø—ã
};
```

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
```javascript
const USER_LIMITS = {
  PROMPT_MAX_LENGTH: 1000,       // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞
  PROMPT_MIN_LENGTH: 3,          // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞
  SESSION_DURATION: 5 * 60 * 1000 // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏ (5 –º–∏–Ω—É—Ç)
};
```

## üìã –ö–æ–º–∞–Ω–¥—ã –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

#### `/start` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–î–µ–π—Å—Ç–≤–∏—è**: 
  - –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Backend API
  - **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–æ–∫–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
  - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –æ –ø–æ–¥–∞—Ä–∫–µ
  - –ü–æ–∫–∞–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏

#### `/help` - –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞
- **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ**:
  - –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
  - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–∞—Ö
  - –°—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É

#### `/balance` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**:
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  - –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫—É–ø–æ–∫
  - –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

#### `/buy` - –ü–æ–∫—É–ø–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–∫—É–ø–∫–∞ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
  - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤
  - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å—Å—ã–ª–∫–∏ YooMoney
  - –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ–ø–ª–∞—Ç—É
  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ

#### `/mystocks` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–∫–æ–≤—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 123RF
- **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:
  - –ü—Ä–∏–≤—è–∑–∫–∞ —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ 123RF
  - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏

### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã

#### **Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã**
```javascript
// –ú–µ–Ω—é –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const imageActionsKeyboard = {
  inline_keyboard: [
    [{ text: 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ 123RF', callback_data: `upload_123rf_${imageId}` }],
    [{ text: 'üìÅ –ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª–æ–º', callback_data: `download_file_${imageId}` }],
    [{ text: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–∫–æ–≤', callback_data: 'manage_stocks' }]
  ]
};

// –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
const pricingKeyboard = {
  inline_keyboard: plans.map(plan => [{
    text: `${plan.name} - ${plan.images} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (${plan.price}‚ÇΩ)`,
    callback_data: JSON.stringify({
      action: 'buy_plan',
      planId: plan.id
    })
  }])
};
```

#### **–ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏**
```javascript
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 123RF
const stockConfigSteps = {
  'awaiting_123rf_username': '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –æ—Ç 123RF:',
  'awaiting_123rf_password': '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –æ—Ç 123RF:',
  'awaiting_ftp_host': '–í–≤–µ–¥–∏—Ç–µ FTP —Ö–æ—Å—Ç (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å):',
  'confirming_settings': '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ:'
};
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

#### **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**
```javascript
// –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞
if (text.length < 3) {
  return bot.sendMessage(chatId, '–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞.');
}

if (text.length > 1000) {
  return bot.sendMessage(chatId, '–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤.');
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
const user = await backendApi.getUser(userId);
if (user.subscription.imagesRemaining <= 0) {
  return sendBalanceMessage(chatId);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const loadingMessage = await bot.sendMessage(chatId, 'üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...');
const image = await backendApi.generateImage(text, user.id, userId);
await bot.deleteMessage(chatId, loadingMessage.message_id);
await sendImageWithActions(chatId, image);
```

## üé® –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –û–±–∑–æ—Ä —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–≤–æ–π–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:

#### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- **–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**: –°–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –º–æ–¥–µ–ª–∏
- **–í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**: –§–∞–π–ª –±–µ–∑ —Å–∂–∞—Ç–∏—è –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –∫–∞—á–µ—Å—Ç–≤–µ 4096x4096
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ** —Ñ–∞–π–ª–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (–¥–∞—Ç–∞, –ø—Ä–æ–º–ø—Ç, ID)
- **–ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞** –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

#### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

1. **–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ**:
   ```
   üé® –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!
   
   ü§ñ –ú–æ–¥–µ–ª—å: Juggernaut Pro Flux
   ```

2. **–í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Ñ–∞–π–ª –±–µ–∑ —Å–∂–∞—Ç–∏—è**:
   ```
   üìÅ –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   
   üìù –ü—Ä–æ–º—Ç: Beautiful sunset over mountains
   üìê –†–∞–∑–º–µ—Ä: 4096x4096
   ```
   + –ö–Ω–æ–ø–∫–∞ "üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ 123RF"

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
```javascript
// 1. –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –∫–Ω–æ–ø–æ–∫
await bot.sendPhoto(chatId, imageStream, {
  caption: `üé® –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!\n\nü§ñ –ú–æ–¥–µ–ª—å: ${imageData.model}`,
  parse_mode: 'Markdown'
});

// 2. –í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Ñ–∞–π–ª –±–µ–∑ —Å–∂–∞—Ç–∏—è + –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
const imageStreamForFile = await backendApi.getImageStream(imageData.id, user.id);
const filename = createFilename(imageData, prompt);

await bot.sendDocument(chatId, imageStreamForFile, {
  caption: `üìÅ –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\n\nüìù –ü—Ä–æ–º—Ç: ${prompt}\nüìê –†–∞–∑–º–µ—Ä: 4096x4096`,
  parse_mode: 'Markdown',
  reply_markup: getUploadOnlyKeyboard(imageData.id, availableServices)
}, {
  filename: filename,
  contentType: 'image/jpeg'
});
```

#### –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
```javascript
function createFilename(imageData, prompt) {
  const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
  const promptSnippet = prompt.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '_');
  return `ai_image_${timestamp}_${promptSnippet}_${imageData.id.substring(0, 8)}.jpg`;
}
```

#### –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
```javascript
function getUploadOnlyKeyboard(imageId, availableServices = []) {
  const keyboard = [];
  
  // –¢–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å—Ç–æ–∫–∏
  if (availableServices.includes('123rf')) {
    keyboard.push([{ text: "üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ 123RF", callback_data: `upload_123rf_${imageId}` }]);
  }
  
  return { inline_keyboard: keyboard };
}
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

#### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø** –∫ –æ–±–æ–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- **–ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏** –Ω–∞–∂–∏–º–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
- **–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** —Å –º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–Ω–æ–ø–æ–∫
- **–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ** –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ –±–µ–∑ —Å–∂–∞—Ç–∏—è

#### –î–ª—è —Å–∏—Å—Ç–µ–º—ã
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞** –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤
- **–£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞** –∑–∞ —Å—á–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫
- **–õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –±–ª–∞–≥–æ–¥–∞—Ä—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
- **–ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫** –∏–∑-–∑–∞ —É–ø—Ä–æ—â–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Backend API

### API Endpoints –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–æ—Ç–æ–º

Telegram –±–æ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å Backend API —á–µ—Ä–µ–∑ —Å–ª–µ–¥—É—é—â–∏–µ endpoints:

#### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** (–ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ [Backend API Reference](../backend/README.md#users-api-apiusers))
```javascript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST /api/users
{
  externalId: telegramUserId,
  externalSystem: "telegram",
  profile: {
    username: telegramUsername,
    firstName: telegramFirstName,
    lastName: telegramLastName,
    language: telegramLanguageCode
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID
GET /api/users/external/{telegramUserId}/telegram

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET /api/users/{userId}/stats
```

#### **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** (–ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ [AI Models Guide](../doc/AI_MODELS_GUIDE.md))
```javascript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
POST /api/images/generate
{
  prompt: "user prompt text",
  userId: userId,
  userExternalId: telegramUserId,
  userExternalSystem: "telegram",
  options: {
    model: "juggernaut-pro-flux"  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞)
GET /api/images/{imageId}/file?userId={userId}
```

#### **–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** (–ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ [Payment System Guide](../doc/PAYMENT_SYSTEM_GUIDE.md))
```javascript
// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
GET /api/payments/plans

// –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
POST /api/payments/create
{
  telegramId: telegramUserId,
  planId: "plan_100",
  returnUrl: "https://t.me/your_bot"
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
GET /api/payments/history/{userId}
```

#### **–°—Ç–æ–∫–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã**
```javascript
// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–æ–∫–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
GET /api/users/{userId}/stock-services

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ 123RF
PUT /api/users/{userId}/stock-services/123rf
{
  enabled: true,
  credentials: {
    username: "123rf_username",
    password: "123rf_password"
  },
  settings: {
    ftpHost: "ftp.123rf.com",
    ftpPort: 21,
    remotePath: "/ai_images"
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ 123RF
POST /api/upload/123rf
{
  imageId: imageId,
  userId: userId,
  title: "AI Generated Image",
  description: "Beautiful AI-generated artwork",
  keywords: ["ai", "generated", "art", "digital"],
  category: "Digital Art"
}
```

### Backend API Service

#### **HTTP Client Configuration**
```javascript
// services/backendApiService.js
const axios = require('axios');

const apiClient = axios.create({
  baseURL: process.env.BACKEND_API_URL,
  timeout: parseInt(process.env.BACKEND_API_TIMEOUT) || 120000,
  headers: {
    'Content-Type': 'application/json',
    'User-Agent': 'AI-Stock-Bot-Telegram/1.0'
  }
});

// Retry –ª–æ–≥–∏–∫–∞
apiClient.interceptors.response.use(
  response => response,
  async error => {
    if (error.response?.status >= 500 && error.config.retries < 3) {
      error.config.retries = (error.config.retries || 0) + 1;
      await new Promise(resolve => setTimeout(resolve, 1000 * error.config.retries));
      return apiClient.request(error.config);
    }
    return Promise.reject(error);
  }
);
```

#### **–ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**
```javascript
async function getImageStream(imageId, userId) {
  try {
    const response = await apiClient.get(`/images/${imageId}/file`, {
      params: { userId },
      responseType: 'stream'
    });
    return response.data;
  } catch (error) {
    logger.error('Failed to get image stream', { imageId, userId, error: error.message });
    throw error;
  }
}
```

#### **Demo Mode Fallback**
```javascript
async function generateImage(prompt, userId, telegramUserId) {
  try {
    const response = await apiClient.post('/images/generate', {
      prompt,
      userId,
      userExternalId: telegramUserId,
      userExternalSystem: 'telegram'
    });
    return response.data.data;
  } catch (error) {
    if (process.env.DEMO_MODE === 'true') {
      logger.warn('API unavailable, using demo mode', { error: error.message });
      return getDemoImage(prompt);
    }
    throw error;
  }
}
```

## üéÅ –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –û–±–∑–æ—Ä —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.

#### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ `/start`
- **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ** —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `TRIAL_IMAGES_COUNT`
- **–ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ** - —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–ª–∞–Ω—Å–æ–º** - –ø–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–¥–∞—Ä–∫–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –õ–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
```javascript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Backend API
if (isNewUser) {
  const trialImagesCount = parseInt(process.env.TRIAL_IMAGES_COUNT) || 10;
  user.subscription.imagesRemaining = trialImagesCount;
  
  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
  user.transactions.push({
    type: 'credit',
    amount: trialImagesCount,
    description: `–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏`,
    createdAt: new Date()
  });
}
```

#### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –±–æ—Ç–µ
```javascript
// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö
if (trialImagesGranted > 0) {
  await bot.sendMessage(chatId, 
    `üéÅ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ ${trialImagesGranted} –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!`
  );
}
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

#### –°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞** –∫–æ–º–∞–Ω–¥–æ–π `/start`
2. **–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç** - –Ω–æ–≤—ã–π –ª–∏ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç** –ø–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
4. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–¥–∞—Ä–∫–∞
5. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é** —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏

#### –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–æ—Ç–µ
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥–∞—Ä–∫–µ**: `üéÅ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 10 –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!`
- **–ú–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏**: –î–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–∫–ª—é—á–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
TRIAL_IMAGES_COUNT=10
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Backend
```javascript
// backend/src/config/config.js
module.exports = {
  trial: {
    imagesCount: parseInt(process.env.TRIAL_IMAGES_COUNT) || 10
  }
};
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

#### –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** –ø–æ–ª—É—á–∏–≤—à–∏—Ö –ø–æ–¥–∞—Ä–æ–∫
- **–ö–æ–Ω–≤–µ—Ä—Å–∏—è** –∏–∑ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø–ª–∞—Ç–Ω—ã–µ –ø–ª–∞–Ω—ã
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** (—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ)
- **–í—Ä–µ–º—è –¥–æ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏** –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```javascript
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
logger.info('Trial images granted', {
  userId: user.id,
  telegramId: user.externalId,
  imagesGranted: trialImagesCount,
  timestamp: new Date().toISOString()
});
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

#### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞
- **–ü–æ–Ω–∏–º–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **–ò–∑—É—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞** –±–µ–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞—Ç—Ä–∞—Ç
- **–ú–æ—Ç–∏–≤–∞—Ü–∏—è –∫ –ø–æ–∫—É–ø–∫–µ** –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞

#### –î–ª—è –±–∏–∑–Ω–µ—Å–∞
- **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏** –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–°–Ω–∏–∂–µ–Ω–∏–µ –±–∞—Ä—å–µ—Ä–∞ –≤—Ö–æ–¥–∞** –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ü–µ–Ω–Ω–æ—Å—Ç–∏** –ø—Ä–æ–¥—É–∫—Ç–∞
- **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö** –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ (—Å –ø–æ–¥–∞—Ä–æ—á–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
```mermaid
sequenceDiagram
    participant User as –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant API as Backend API
    participant DB as MongoDB

    User->>Bot: /start
    Bot->>API: POST /api/users (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    API->>DB: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    Note over API,DB: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    API->>DB: user.subscription.imagesRemaining = 10
    API->>DB: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ "–ø–æ–¥–∞—Ä–æ—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
    DB->>API: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —Å –±–∞–ª–∞–Ω—Å–æ–º 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    API->>Bot: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + trialImagesGranted: 10
    Bot->>User: "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AI Stock Bot!"
    Bot->>User: "üéÅ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 10 –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!"
    Bot->>User: –ú–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞)
    
    Note over User,Bot: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    User->>Bot: "Beautiful sunset"
    Bot->>API: POST /api/images/generate
    Note over API: –°–ø–∏—Å–∞–Ω–∏–µ 1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –±–∞–ª–∞–Ω—Å–∞ (9 –æ—Å—Ç–∞–ª–æ—Å—å)
    API->>Bot: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    Bot->>User: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
```

### 2. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
### 2. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant API as Backend API
    participant DB as MongoDB
    participant YM as YooMoney

    User->>Bot: /start
    Bot->>API: POST /api/users (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
    API->>DB: –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    DB->>API: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    API->>Bot: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    Bot->>API: GET /api/users/{userId}/stock-services
    API->>Bot: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–∫–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
    Bot->>User: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –º–µ–Ω—é
    
    Note over User,Bot: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –±–∞–ª–∞–Ω—Å = 0
    User->>Bot: /buy –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
    Bot->>API: GET /api/payments/plans
    API->>Bot: –°–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
    Bot->>User: Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –ø–ª–∞–Ω–∞–º–∏
    User->>Bot: –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ (callback)
    Bot->>API: POST /api/payments/create
    API->>YM: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    YM->>API: –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Å—ã–ª–∫–∞
    API->>Bot: URL –¥–ª—è –æ–ø–ª–∞—Ç—ã
    Bot->>User: –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É YooMoney
    
    Note over User,YM: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
    YM->>API: Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    API->>DB: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    API->>Bot: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Bot API
    Bot->>User: "‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω! –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω"
```

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant API as Backend API
    participant AI as AI Provider

    User->>Bot: "Beautiful sunset over mountains"
    Bot->>Bot: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞
    Bot->>API: GET /api/users/external/{telegramId}/telegram
    API->>Bot: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –±–∞–ª–∞–Ω—Å
    
    alt –ë–∞–ª–∞–Ω—Å > 0
        Bot->>User: "üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ..."
        Bot->>API: POST /api/images/generate
        API->>AI: –ó–∞–ø—Ä–æ—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        AI->>API: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        API->>Bot: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        Bot->>API: GET /api/images/{imageId}/file (stream)
        API->>Bot: –ü–æ—Ç–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        Bot->>User: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + inline –∫–Ω–æ–ø–∫–∏
    else –ë–∞–ª–∞–Ω—Å = 0
        Bot->>User: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π" + –∫–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏
    end
```

### 3. –ü–æ–∫—É–ø–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant API as Backend API
    participant YM as YooMoney

    User->>Bot: /buy –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å"
    Bot->>API: GET /api/payments/plans
    API->>Bot: –°–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
    Bot->>User: Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –ø–ª–∞–Ω–∞–º–∏
    User->>Bot: –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ (callback)
    Bot->>API: POST /api/payments/create
    API->>YM: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    YM->>API: –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Å—ã–ª–∫–∞
    API->>Bot: URL –¥–ª—è –æ–ø–ª–∞—Ç—ã
    Bot->>User: –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É YooMoney
    
    Note over YM,API: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
    YM->>API: Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    API->>API: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    API->>Bot: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Bot API
    Bot->>User: "‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω! –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω"
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 123RF
```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant API as Backend API
    participant FTP as 123RF FTP

    User->>Bot: /mystocks
    Bot->>API: GET /api/users/{userId}/stock-services
    API->>Bot: –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    Bot->>User: –ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–æ–∫–æ–≤—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
    User->>Bot: "–ü—Ä–∏–≤—è–∑–∞—Ç—å 123RF" (callback)
    Bot->>User: "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –æ—Ç 123RF:"
    User->>Bot: "my_username"
    Bot->>User: "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –æ—Ç 123RF:"
    User->>Bot: "my_password"
    Bot->>API: PUT /api/users/{userId}/stock-services/123rf
    API->>FTP: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    
    alt –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
        FTP->>API: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ OK
        API->>Bot: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
        Bot->>User: "‚úÖ 123RF —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!"
    else –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        FTP->>API: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        API->>Bot: –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        Bot->>User: "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ."
    end
```

### 5. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å—Ç–æ–∫–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å
```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant API as Backend API
    participant FTP as 123RF FTP

    User->>Bot: –ö–Ω–æ–ø–∫–∞ "üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ 123RF"
    Bot->>API: GET /api/users/{userId}/stock-services
    API->>Bot: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ 123RF
    
    alt 123RF –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        Bot->>User: "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:"
        User->>Bot: "Beautiful Mountain Sunset"
        Bot->>User: "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ:"
        User->>Bot: "AI-generated landscape..."
        Bot->>User: "–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):"
        User->>Bot: "landscape, sunset, mountains, ai"
        Bot->>API: POST /api/upload/123rf
        API->>FTP: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        FTP->>API: –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏
        API->>Bot: –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
        Bot->>User: "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ 123RF!"
    else 123RF –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        Bot->>User: "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ 123RF –≤ /mystocks"
    end
```

### 6. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –±–µ–∑ —Å–∂–∞—Ç–∏—è
```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Bot as Telegram Bot
    participant API as Backend API

    User->>Bot: –ö–Ω–æ–ø–∫–∞ "üìÅ –ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª–æ–º"
    Bot->>User: "üìÅ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è..."
    Bot->>API: GET /api/images/{imageId}/stream?userId={userId}
    API->>Bot: –ü–æ—Ç–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–±–µ–∑ —Å–∂–∞—Ç–∏—è)
    Bot->>Bot: –°–æ–∑–¥–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
    Bot->>User: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    Bot->>User: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ bot.sendDocument()
    
    Note over User,Bot: –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±–µ–∑ —Å–∂–∞—Ç–∏—è Telegram
    Note over User,Bot: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ 4096x4096
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### **–ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**
```javascript
function validatePrompt(text) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
  if (text.length < 3) {
    return { valid: false, error: '–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞.' };
  }
  
  if (text.length > 1000) {
    return { valid: false, error: '–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤.' };
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
  const forbiddenWords = ['explicit', 'nsfw', 'adult'];
  const lowerText = text.toLowerCase();
  for (const word of forbiddenWords) {
    if (lowerText.includes(word)) {
      return { valid: false, error: '–ü—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.' };
    }
  }
  
  return { valid: true };
}
```

#### **–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–∫–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤**
```javascript
function validateStockCredentials(username, password) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞
  if (!username || username.length < 3) {
    return { valid: false, error: '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞.' };
  }
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
  if (!password || password.length < 6) {
    return { valid: false, error: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.' };
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –ª–æ–≥–∏–Ω–µ
  if (!/^[a-zA-Z0-9_.-]+$/.test(username)) {
    return { valid: false, error: '–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫–∏, –¥–µ—Ñ–∏—Å—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è.' };
  }
  
  return { valid: true };
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

#### **–ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**
```javascript
// –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
const userSessions = new Map();

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Å—Å–∏–∏
function createSession(userId, step, data = {}) {
  return {
    userId,
    step,
    data,
    timestamp: Date.now(),
    expiresAt: Date.now() + (5 * 60 * 1000) // 5 –º–∏–Ω—É—Ç
  };
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Å–µ—Å—Å–∏–π
setInterval(() => {
  const now = Date.now();
  for (const [userId, session] of userSessions.entries()) {
    if (session.expiresAt < now) {
      userSessions.delete(userId);
      logger.debug('Session expired', { userId });
    }
  }
}, 60000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
```

#### **–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞**
```javascript
// Rate limiting –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userLastAction = new Map();
const RATE_LIMIT_DELAY = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

function checkRateLimit(userId) {
  const lastAction = userLastAction.get(userId);
  const now = Date.now();
  
  if (lastAction && (now - lastAction) < RATE_LIMIT_DELAY) {
    return false;
  }
  
  userLastAction.set(userId, now);
  return true;
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
```javascript
function sanitizeInput(text) {
  return text
    .trim()
    .replace(/[<>]/g, '') // –£–¥–∞–ª–µ–Ω–∏–µ HTML —Ç–µ–≥–æ–≤
    .substring(0, 1000);  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã
}
```

#### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
```javascript
function logUserAction(action, userId, data = {}) {
  // –£–¥–∞–ª–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–æ–≥–æ–≤
  const sanitizedData = { ...data };
  delete sanitizedData.password;
  delete sanitizedData.token;
  
  logger.info('User action', {
    action,
    userId: userId.toString(), // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ —Å—Ç—Ä–æ–∫—É
    data: sanitizedData,
    timestamp: new Date().toISOString()
  });
}
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### **Winston Logger Configuration**
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),
    new winston.transports.File({ 
      filename: 'logs/error.log', 
      level: 'error' 
    }),
    new winston.transports.File({ 
      filename: 'logs/combined.log' 
    })
  ]
});
```

#### **–õ–æ–≥–∏—Ä—É–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è**
```javascript
// –î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
logger.info('User message received', {
  userId: msg.from.id,
  username: msg.from.username,
  messageType: msg.text ? 'text' : 'other',
  promptLength: msg.text?.length,
  timestamp: new Date().toISOString()
});

// API –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
logger.info('Backend API request', {
  endpoint: '/api/images/generate',
  userId: userId,
  method: 'POST',
  responseTime: Date.now() - startTime
});

// –û—à–∏–±–∫–∏
logger.error('Image generation failed', {
  userId: userId,
  prompt: prompt.substring(0, 100),
  error: error.message,
  stack: error.stack
});

// –ü–ª–∞—Ç–µ–∂–∏
logger.info('Payment created', {
  userId: userId,
  planId: planId,
  amount: plan.price,
  paymentId: payment.paymentId
});
```

### Health Check –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

#### **Backend API Health Check**
```javascript
async function checkBackendHealth() {
  try {
    const response = await backendApi.get('/health', { timeout: 5000 });
    const isHealthy = response.status === 200;
    
    logger.debug('Backend health check', {
      status: response.status,
      healthy: isHealthy,
      responseTime: response.headers['x-response-time']
    });
    
    return isHealthy;
  } catch (error) {
    logger.warn('Backend API unavailable', {
      error: error.message,
      code: error.code
    });
    return false;
  }
}

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
setInterval(async () => {
  const isHealthy = await checkBackendHealth();
  if (!isHealthy && process.env.DEMO_MODE !== 'true') {
    logger.error('Backend API is down and demo mode is disabled');
  }
}, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
```

#### **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```javascript
// –°—á–µ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
const metrics = {
  messagesProcessed: 0,
  imagesGenerated: 0,
  paymentsCreated: 0,
  errorsOccurred: 0,
  apiRequestsTotal: 0,
  apiRequestsFailed: 0
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
function updateMetrics(event, success = true) {
  metrics[event] = (metrics[event] || 0) + 1;
  if (!success) {
    metrics.errorsOccurred++;
  }
}

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥ –º–µ—Ç—Ä–∏–∫
setInterval(() => {
  logger.info('Bot metrics', {
    messagesProcessed: metrics.messagesProcessed,
    imagesGenerated: metrics.imagesGenerated,
    paymentsCreated: metrics.paymentsCreated,
    errorsOccurred: metrics.errorsOccurred,
    successRate: (metrics.apiRequestsTotal - metrics.apiRequestsFailed) / metrics.apiRequestsTotal,
    timestamp: new Date().toISOString()
  });
}, 300000); // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
```

### –ê–ª–µ—Ä—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏**
```javascript
async function sendCriticalAlert(error, context = {}) {
  logger.error('Critical error occurred', {
    error: error.message,
    stack: error.stack,
    context,
    timestamp: new Date().toISOString()
  });
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
  if (process.env.ADMIN_CHAT_ID) {
    try {
      await bot.sendMessage(process.env.ADMIN_CHAT_ID, 
        `üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:\n\n${error.message}\n\n–í—Ä–µ–º—è: ${new Date().toLocaleString()}`
      );
    } catch (alertError) {
      logger.error('Failed to send admin alert', { error: alertError.message });
    }
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
process.on('uncaughtException', (error) => {
  sendCriticalAlert(error, { type: 'uncaughtException' });
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  sendCriticalAlert(new Error(reason), { type: 'unhandledRejection', promise });
});
```

## üê≥ Docker Development

### Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### **Dockerfile**
```dockerfile
# Multi-stage build –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
FROM node:18-alpine AS base
WORKDIR /app
COPY package*.json ./

# Development stage
FROM base AS development
RUN npm ci
COPY . .
EXPOSE 3001
CMD ["npm", "run", "dev"]

# Production stage
FROM base AS production
RUN npm ci --only=production && npm cache clean --force
COPY . .
USER node
CMD ["npm", "start"]
```

#### **Docker Compose –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
```yaml
# –ò–∑ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ docker-compose.yml
tg-bot:
  build:
    context: ./tg-bot
    dockerfile: Dockerfile
    target: development
  environment:
    - NODE_ENV=development
    - BOT_TOKEN=${BOT_TOKEN}
    - BACKEND_API_URL=http://backend:3000/api
    - DEMO_MODE=false
  volumes:
    - ./tg-bot:/app
    - /app/node_modules
  depends_on:
    - backend
  networks:
    - ai-stock-bot-network
  profiles:
    - bot
  restart: unless-stopped
```

### Docker –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

#### **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã**
```bash
# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞ (—Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã–π backend)
docker-compose --profile bot up -d

# –ó–∞–ø—É—Å–∫ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã (backend + bot)
docker-compose --profile backend --profile bot up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –±–æ—Ç–∞
docker-compose logs -f tg-bot

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
docker-compose restart tg-bot

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
docker-compose stop tg-bot

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –±–æ—Ç–∞
docker-compose build tg-bot
```

#### **–û—Ç–ª–∞–¥–∫–∞ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞**
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –±–æ—Ç–∞
docker-compose exec tg-bot sh

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
docker-compose exec tg-bot env

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker-compose exec tg-bot ps aux

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
docker-compose logs tg-bot | grep ERROR
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

#### **Volumes –∏ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
- **Hot reload**: –ö–æ–¥ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –¥–ª—è live –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ development
- **node_modules**: –ò—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–õ–æ–≥–∏**: –í—ã–≤–æ–¥—è—Ç—Å—è –≤ stdout –¥–ª—è Docker logs

#### **–°–µ—Ç–µ–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ**
- **–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å**: –ë–æ—Ç –æ–±—â–∞–µ—Ç—Å—è —Å backend —á–µ—Ä–µ–∑ Docker network
- **DNS resolution**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ `backend` –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **–ò–∑–æ–ª—è—Ü–∏—è**: –ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ MongoDB

#### **Environment Variables**
```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è Docker
BOT_TOKEN=your_bot_token
BACKEND_API_URL=http://backend:3000/api

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
DEMO_MODE=false
LOG_LEVEL=info
ADMIN_CHAT_ID=123456789  # –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

#### **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã**
- **Backend API**: [../backend/README.md](../backend/README.md) - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Backend API
- **AI Models**: [../doc/AI_MODELS_GUIDE.md](../doc/AI_MODELS_GUIDE.md) - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ AI –º–æ–¥–µ–ª—è–º
- **Payment System**: [../doc/PAYMENT_SYSTEM_GUIDE.md](../doc/PAYMENT_SYSTEM_GUIDE.md) - –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ YooMoney
- **Database**: [../doc/DATABASE_GUIDE.md](../doc/DATABASE_GUIDE.md) - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **Admin API**: [../doc/ADMIN_API_GUIDE.md](../doc/ADMIN_API_GUIDE.md) - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π API
- **Production**: [../doc/PRODUCTION.md](../doc/PRODUCTION.md) - –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

#### **–í–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã**
- **Telegram Bot API**: [https://core.telegram.org/bots/api](https://core.telegram.org/bots/api)
- **BotFather**: [https://t.me/BotFather](https://t.me/BotFather) - –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏
- **YooMoney API**: [https://yoomoney.ru/docs/](https://yoomoney.ru/docs/) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- **123RF API**: [https://www.123rf.com/api/](https://www.123rf.com/api/) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å—Ç–æ–∫–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

#### **–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞**
- **GitHub Issues**: [https://github.com/alexanderrodnin/ai-stock-bot/issues](https://github.com/alexanderrodnin/ai-stock-bot/issues)
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞**: [https://github.com/alexanderrodnin/ai-stock-bot/tree/main/doc](https://github.com/alexanderrodnin/ai-stock-bot/tree/main/doc)

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

#### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞**
```javascript
// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
async function sendDailyReport() {
  if (!process.env.ADMIN_CHAT_ID) return;
  
  const report = `üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç AI Stock Bot

üî¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å—É—Ç–∫–∏:
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${metrics.messagesProcessed}
‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${metrics.imagesGenerated}
‚Ä¢ –ü–ª–∞—Ç–µ–∂–µ–π —Å–æ–∑–¥–∞–Ω–æ: ${metrics.paymentsCreated}
‚Ä¢ –û—à–∏–±–æ–∫: ${metrics.errorsOccurred}

‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
‚Ä¢ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å API –∑–∞–ø—Ä–æ—Å–æ–≤: ${((metrics.apiRequestsTotal - metrics.apiRequestsFailed) / metrics.apiRequestsTotal * 100).toFixed(1)}%
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π: ${userSessions.size}

üïê –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}`;

  try {
    await bot.sendMessage(process.env.ADMIN_CHAT_ID, report);
  } catch (error) {
    logger.error('Failed to send daily report', { error: error.message });
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00
const cron = require('node-cron');
cron.schedule('0 9 * * *', sendDailyReport);
```

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**AI Stock Bot Telegram Interface** –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π Telegram –±–æ—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ë–æ—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

### ‚úÖ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã
- **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π YooMoney
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** –Ω–∞ —Å—Ç–æ–∫–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã (123RF)
- **–ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏** –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **Graceful degradation** —Å demo —Ä–µ–∂–∏–º–æ–º –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **Retry –ª–æ–≥–∏–∫–∞** –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫ —Å–±–æ—è–º
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **Rate limiting** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- **Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- **Stateless –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** –¥–ª—è –ª–µ–≥–∫–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- **Comprehensive –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏ –º–æ–∂–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –∏ –æ—Ç–ª–∏—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç.
